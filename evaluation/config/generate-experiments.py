import json
from pathlib import Path

import yaml

REPO_ROOT = Path(__file__).parents[2]
EXPERIMENT_LOG_PATH = Path(__file__).parents[2] / "experiments/logs"
EXPERIMENT_CONFIG_FP = Path(__file__).parent / "experiments.yaml"

HEADER = """\
# AUTOMATICALLY GENERATED BY generate-experiments.py
# This file maps experiment IDs to various metadata items.
# Experiments should be referred to by their ID, generally.
# All paths are relative to the repo root.
"""


def slugify(text):
    return text.lower().replace(" ", "-")


data = []

for subdir in EXPERIMENT_LOG_PATH.iterdir():
    if not subdir.is_dir():
        continue
    with open(subdir / "meta.json") as f:
        meta = json.load(f)
    data.append({"id": slugify(meta["name"]), "log_dir": str(subdir.relative_to(REPO_ROOT)), **meta})

data = sorted(data, key=lambda d: d["id"])

with open(EXPERIMENT_CONFIG_FP, "w") as f:
    f.write(HEADER)
    yaml.safe_dump(data, f)
